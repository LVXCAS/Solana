---
phase: 02-professional-metadata
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/services/ipfs.ts
  - src/utils/validation.ts
autonomous: true
user_setup:
  - service: pinata
    why: "IPFS storage for token images and metadata JSON"
    env_vars:
      - name: PINATA_JWT
        source: "Pinata Dashboard -> API Keys -> New Key -> Copy JWT"
    dashboard_config:
      - task: "Create Pinata account"
        location: "https://app.pinata.cloud/register"

must_haves:
  truths:
    - "Image file uploads to IPFS and returns gateway URL"
    - "Metadata JSON uploads to IPFS and returns gateway URL"
    - "Upload errors provide remediation hints"
  artifacts:
    - path: "src/services/ipfs.ts"
      provides: "IPFS upload via Pinata SDK"
      exports: ["uploadImage", "uploadMetadata", "IpfsUploadResult"]
    - path: "src/utils/validation.ts"
      provides: "Image validation (file exists, type, size)"
      exports: ["validateImagePath"]
  key_links:
    - from: "src/services/ipfs.ts"
      to: "pinata SDK"
      via: "PinataSDK constructor with JWT"
      pattern: "new PinataSDK.*pinataJwt"
---

<objective>
Add IPFS storage capability via Pinata for token logos and metadata JSON.

Purpose: Token metadata requires permanent, decentralized storage for images and JSON. Pinata provides free tier IPFS pinning (1GB storage, 500 files) suitable for a learning project.

Output: Working IPFS service that can upload images and JSON, returning gateway URLs for use in Metaplex metadata.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Research
@.planning/phases/02-professional-metadata/02-RESEARCH.md

# Existing code patterns
@src/lib/token.ts
@src/utils/display.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Metaplex and Pinata dependencies</name>
  <files>package.json</files>
  <action>
Install the dependencies identified in research:

```bash
npm install @metaplex-foundation/umi @metaplex-foundation/umi-bundle-defaults @metaplex-foundation/mpl-token-metadata pinata
```

These provide:
- `@metaplex-foundation/umi` (v1.4.1) - Solana framework for JS clients
- `@metaplex-foundation/umi-bundle-defaults` (v1.4.1) - Default Umi plugins
- `@metaplex-foundation/mpl-token-metadata` (v3.4.0) - Token Metadata program
- `pinata` (v2.5.2) - Current Pinata SDK (NOT deprecated @pinata/sdk)

Verify TypeScript types are included (Metaplex and Pinata packages include their own types).
  </action>
  <verify>
`npm ls @metaplex-foundation/umi pinata` shows installed versions
`npm run build` succeeds with no type errors
  </verify>
  <done>All Phase 2 dependencies installed and TypeScript compilation succeeds</done>
</task>

<task type="auto">
  <name>Task 2: Create IPFS upload service with Pinata</name>
  <files>src/services/ipfs.ts, src/utils/validation.ts</files>
  <action>
Create `src/services/` directory if needed.

Create `src/services/ipfs.ts` with:

1. **IpfsUploadResult interface:**
```typescript
export interface IpfsUploadResult {
  cid: string;
  uri: string;  // Full gateway URL
}
```

2. **TokenMetadataJson interface:**
```typescript
export interface TokenMetadataJson {
  name: string;
  symbol: string;
  description: string;
  image: string;  // IPFS URI of uploaded image
}
```

3. **getPinataClient function:**
- Create PinataSDK instance using `process.env.PINATA_JWT`
- Use gateway: "gateway.pinata.cloud"
- Throw descriptive error if PINATA_JWT not set, with remediation hint

4. **uploadImage function:**
```typescript
export async function uploadImage(imagePath: string): Promise<IpfsUploadResult>
```
- Read file from disk using fs.readFile
- Create File object from buffer with proper MIME type (image/png, image/jpeg, image/gif, image/webp based on extension)
- Call `pinata.upload.public.file(file)`
- Return `{ cid, uri: https://gateway.pinata.cloud/ipfs/${cid} }`
- Wrap errors with remediation hints (rate limit, auth, file issues)

5. **uploadMetadata function:**
```typescript
export async function uploadMetadata(metadata: TokenMetadataJson): Promise<IpfsUploadResult>
```
- Create File from JSON.stringify(metadata) with type "application/json"
- Call `pinata.upload.public.file(file)`
- Return `{ cid, uri }`
- Handle errors with remediation hints

Create `src/utils/validation.ts` with:

1. **validateImagePath function:**
```typescript
export async function validateImagePath(imagePath: string): Promise<{ valid: boolean; error?: string }>
```
- Check file exists using fs.access
- Check extension is .png, .jpg, .jpeg, .gif, or .webp
- Check file size is under 10MB (Pinata free tier limit)
- Return descriptive errors for each failure case

Use Node.js fs/promises for file operations (ESM compatible).
  </action>
  <verify>
TypeScript compilation succeeds: `npm run build`
File structure exists:
- `src/services/ipfs.ts` exports uploadImage, uploadMetadata, IpfsUploadResult, TokenMetadataJson
- `src/utils/validation.ts` exports validateImagePath
  </verify>
  <done>IPFS service ready to upload images and metadata JSON via Pinata, with proper validation and error handling</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` - compiles without errors
2. Service files exist with correct exports
3. Dependencies in package.json match research recommendations
</verification>

<success_criteria>
- Pinata SDK (v2.5.2+) and Metaplex packages installed
- uploadImage function accepts file path, returns IPFS URI
- uploadMetadata function accepts metadata object, returns IPFS URI
- validateImagePath checks existence, type, and size
- Error messages include remediation hints (consistent with Phase 1 patterns)
- Code follows ESM patterns established in Phase 1
</success_criteria>

<output>
After completion, create `.planning/phases/02-professional-metadata/02-01-SUMMARY.md`
</output>
