---
phase: 01-security-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/token.ts
  - src/lib/wallet.ts
  - src/utils/display.ts
autonomous: true

must_haves:
  truths:
    - "createToken() creates a real SPL token mint on devnet"
    - "Mint authority is null after token creation (verified on-chain)"
    - "Freeze authority is null after token creation (verified on-chain)"
    - "Token supply matches requested amount"
    - "getMint() returns valid mint info with correct decimals"
  artifacts:
    - path: "src/lib/token.ts"
      provides: "SPL token creation and authority revocation"
      exports: ["createToken", "revokeAuthorities", "verifyAuthorities", "mintInitialSupply"]
    - path: "src/lib/wallet.ts"
      provides: "Keypair loading and balance checking"
      exports: ["loadKeypair", "getBalance", "checkSufficientBalance"]
  key_links:
    - from: "src/lib/token.ts"
      to: "@solana/spl-token"
      via: "createMint, setAuthority, getMint, mintTo"
      pattern: "import.*from.*@solana/spl-token"
    - from: "src/lib/token.ts"
      to: "@solana/web3.js"
      via: "Connection, Keypair, PublicKey"
      pattern: "import.*from.*@solana/web3.js"
    - from: "src/lib/wallet.ts"
      to: "~/.config/solana/id.json"
      via: "fs.readFile for keypair loading"
      pattern: "readFile.*json"
---

<objective>
Implement core SPL token creation with automatic authority revocation using @solana/spl-token library.

Purpose: This is the heart of Phase 1 - creating tokens with anti-rug guarantees. After this plan completes, we can create real SPL tokens on devnet with permanently revoked mint and freeze authorities.

Output: Working token.ts and wallet.ts modules that create tokens on Solana devnet with security controls.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-security-foundation/01-RESEARCH.md
@.planning/phases/01-security-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement wallet management (loadKeypair, getBalance)</name>
  <files>src/lib/wallet.ts</files>
  <action>
    Implement wallet.ts with Solana keypair loading and balance checking:

    1. loadKeypair(path: string): Promise&lt;Keypair&gt;
       - Read JSON file from path (default: ~/.config/solana/id.json)
       - Parse as Uint8Array (Solana CLI format: array of 64 numbers)
       - Return Keypair.fromSecretKey()
       - Handle errors: file not found, invalid JSON, invalid key format
       - Expand ~ to os.homedir()

    2. getBalance(connection: Connection, publicKey: PublicKey): Promise&lt;number&gt;
       - Call connection.getBalance(publicKey)
       - Return balance in lamports

    3. checkSufficientBalance(connection: Connection, publicKey: PublicKey, required: number): Promise&lt;{sufficient: boolean, balance: number, required: number}&gt;
       - Get current balance
       - Compare to required amount
       - Return object with all info for error messages

    Import types from @solana/web3.js:
    - Connection, Keypair, PublicKey

    Use fs/promises for async file reading.
    Use os.homedir() for ~ expansion.
  </action>
  <verify>
    Create a simple test script that:
    1. Loads keypair from default Solana path
    2. Connects to devnet
    3. Gets balance
    4. Prints public key and balance

    Run: npx ts-node -e "import('./src/lib/wallet.js').then(w => w.loadKeypair('~/.config/solana/id.json').then(k => console.log(k.publicKey.toBase58())))"

    Should print a valid Solana public key (base58 string).
  </verify>
  <done>
    - loadKeypair successfully loads Solana CLI keypairs
    - getBalance returns balance in lamports
    - checkSufficientBalance returns comparison object
    - Errors are thrown with clear messages for file not found, invalid format
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement token creation with authority revocation</name>
  <files>src/lib/token.ts</files>
  <action>
    Implement token.ts with SPL token creation and authority management:

    1. Define TokenConfig interface:
       ```typescript
       interface TokenConfig {
         name: string;
         symbol: string;
         decimals: number;
         supply: number;
       }
       ```

    2. Define TokenResult interface:
       ```typescript
       interface TokenResult {
         mint: PublicKey;
         tokenAccount: PublicKey;
         mintTxSignature: string;
         revokeAuthoritiesTxSignatures: string[];
         supply: bigint;
       }
       ```

    3. createToken(connection: Connection, payer: Keypair, config: TokenConfig): Promise&lt;TokenResult&gt;

       Implementation steps:
       a. Create mint account using createMint():
          - payer: fee payer
          - mintAuthority: payer.publicKey (temporary, will revoke)
          - freezeAuthority: payer.publicKey (temporary, will revoke)
          - decimals: config.decimals

       b. Create associated token account for payer using getOrCreateAssociatedTokenAccount()

       c. Mint initial supply using mintTo():
          - Calculate actual amount: supply * (10 ** decimals)
          - Mint to payer's token account

       d. Revoke mint authority using setAuthority():
          - AuthorityType.MintTokens
          - newAuthority: null (permanently revokes)

       e. Revoke freeze authority using setAuthority():
          - AuthorityType.FreezeAccount
          - newAuthority: null (permanently revokes)

       f. Return TokenResult with all transaction signatures

    4. verifyAuthorities(connection: Connection, mint: PublicKey): Promise&lt;{mintAuthority: string | null, freezeAuthority: string | null}&gt;
       - Use getMint() to fetch mint account info
       - Return authority status (null means revoked, base58 string if still set)
       - This is critical for confirming revocation succeeded

    5. Helper function estimateCost(connection: Connection): Promise&lt;{rent: number, fees: number, total: number}&gt;
       - Get rent exemption for MINT_SIZE (82 bytes)
       - Calculate fees: 5000 lamports * 4 signatures (createMint, createAccount, mintTo, 2x setAuthority)
       - Return breakdown in lamports

    Imports from @solana/spl-token:
    - createMint, setAuthority, AuthorityType, getMint, MINT_SIZE
    - mintTo, getOrCreateAssociatedTokenAccount

    Imports from @solana/web3.js:
    - Connection, Keypair, PublicKey

    CRITICAL: Use null (not undefined) for revoking authorities. The research doc warns about this pitfall explicitly.
  </action>
  <verify>
    Create integration test that:
    1. Connects to devnet
    2. Loads local keypair
    3. Creates token with: name="TestToken", symbol="TEST", decimals=9, supply=1000000
    4. Verifies authorities are null using verifyAuthorities()
    5. Prints mint address and Explorer link

    This requires devnet SOL. If balance insufficient, test will fail with clear message.

    Run: npm run dev -- create --test (if test flag implemented, otherwise manual verification)

    Manual verification:
    - Visit Solana Explorer with mint address
    - Confirm "Mint Authority: Disabled" and "Freeze Authority: Disabled"
  </verify>
  <done>
    - createToken() successfully creates SPL token on devnet
    - Initial supply minted to payer's associated token account
    - Mint authority is revoked (null) - verified via getMint()
    - Freeze authority is revoked (null) - verified via getMint()
    - All transaction signatures returned for verification
    - estimateCost() returns accurate cost breakdown
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Unit test wallet.ts:
   ```bash
   npx ts-node -e "
   import { loadKeypair, getBalance } from './src/lib/wallet.js';
   import { Connection, clusterApiUrl } from '@solana/web3.js';
   const conn = new Connection(clusterApiUrl('devnet'));
   loadKeypair('~/.config/solana/id.json')
     .then(kp => getBalance(conn, kp.publicKey))
     .then(bal => console.log('Balance:', bal, 'lamports'))
     .catch(console.error);
   "
   ```

2. Integration test token creation (requires devnet SOL):
   ```bash
   # First airdrop if needed: solana airdrop 2 --url devnet
   npx ts-node -e "
   import { loadKeypair } from './src/lib/wallet.js';
   import { createToken, verifyAuthorities } from './src/lib/token.js';
   import { Connection, clusterApiUrl } from '@solana/web3.js';
   const conn = new Connection(clusterApiUrl('devnet'), 'confirmed');
   loadKeypair('~/.config/solana/id.json')
     .then(async kp => {
       const result = await createToken(conn, kp, {
         name: 'TestToken', symbol: 'TEST', decimals: 9, supply: 1000000
       });
       console.log('Mint:', result.mint.toBase58());
       const auth = await verifyAuthorities(conn, result.mint);
       console.log('Mint Authority:', auth.mintAuthority ?? 'REVOKED');
       console.log('Freeze Authority:', auth.freezeAuthority ?? 'REVOKED');
     })
     .catch(console.error);
   "
   ```

3. Verify on Solana Explorer:
   - Open https://explorer.solana.com/address/{MINT_ADDRESS}?cluster=devnet
   - Confirm "Mint Authority: Disabled"
   - Confirm "Freeze Authority: Disabled"
</verification>

<success_criteria>
Phase 1 Plan 02 is complete when:
- loadKeypair() successfully loads Solana CLI format keypairs
- getBalance() returns wallet balance in lamports
- createToken() creates real SPL token on devnet with correct decimals and supply
- Authority revocation works: mintAuthority and freezeAuthority are both null
- verifyAuthorities() confirms revocation via getMint()
- estimateCost() returns accurate cost breakdown
- All functions handle errors gracefully with clear messages
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-foundation/01-02-SUMMARY.md`
</output>
